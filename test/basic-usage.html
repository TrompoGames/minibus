<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Minibus.js test suite: Basic usage</title>
  <link rel="stylesheet" href="lib/qunit-1.13.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="lib/qunit-1.13.0.js"></script>
  <script src="../minibus.js"></script>
  <script type="text/javascript">
    
    asyncTest('on & emit with object param', function () {
      
      var bus = Minibus.create();
      
      bus.on('myevent', function (param1) {
        ok(param1.msg === 'hello', 'Parameter should be passed.');
        ok(param1 === this, 'First parameter should be the context.');
        start();
      });
      
      bus.emit('myevent', {msg:'hello'});
    });
    
    asyncTest('on & emit with non-object param', function () {
      stop(2); // Three start() calls
      
      var bus = Minibus.create();
      bus.on('myevent', function (param1) {
        deepEqual(this, {}, 'Context should not be the first parameter.');
        start();
      });
      bus.emit('myevent', 'hello');
      bus.emit('myevent', 3);
      bus.emit('myevent', undefined);
    });
    
    asyncTest('on & off & emit', function () {
      var bus = Minibus.create();
      bus.on('myevent', function () {
        ok(false, 'Should not be executed.');
      });
      bus.on('otherevent', function () {
        ok(true, 'Should be executed.');
        start();
      });
      
      bus.off('myevent');
      
      bus.emit('myevent'); // Should not work
      bus.emit('otherevent'); // Should work
    });
    
    asyncTest('route', function () {
      expect(1); // expect only one assertion
      
      var bus = Minibus.create();
      var route = bus.on('myevent', function () {
        ok(false, 'Should not be executed.');
      });
      var route2 = bus.on('myevent', function () {
        ok(true, 'Should be executed.');
        start();
      });
      bus.off(route);
      bus.emit('myevent');
    });
    
    asyncTest('alternative function names', function testCase() {
      expect(1);
      var bus = Minibus.create();
      bus.listen('myevent', function handler() {
        ok(true, 'Should be called');
      });
      bus.trigger('myevent');
      bus.removeListener('myevent');
      bus.trigger('myevent');
      setTimeout(start, 0); // handler may not be called immediately.
    });
    
    asyncTest('once', function testCase() {
      expect(1); // Only one assertion
      var called = false;
      var bus = Minibus.create();
      bus.once('myevent', function () {
        ok(!called, 'Should be executed once.');
        called = true;
      });
      bus.emit('myevent');
      bus.emit('myevent');
      setTimeout(start, 0); // exec all in event stack stack
    });
    
    asyncTest('once and then on', function testCase() {
      expect(3);
      called = 0;
      var bus = Minibus.create();
      var fun = function (num) {
        ok(called === num, 'Should be executed thrice.');
        called += 1;
      };
      bus.once('myevent', fun);
      bus.on('myevent', fun);
      bus.emit('myevent', 0);
      bus.emit('myevent', 1);
      bus.emit('myevent', 2);
      setTimeout(start, 0); // exec all in event stack stack
    });
    
    asyncTest('off all', function testCase() {
      expect(1);
      var bus = Minibus.create();
      bus.on('myevent1', function handler() {
        ok(true, 'Should be called once.');
      });
      bus.on('myevent2', function handler() {
        ok(false, 'Should not be called');
      });
      bus.once('myevent3', function handler() {
        ok(false, 'Should not be called');
      });
      
      bus.emit('myevent1');
      bus.off();
      bus.emit('myevent2');
      bus.emit('myevent1');
      setTimeout(start, 0); // handler may not be called immediately.
    });
    
  </script>
</body>
</html>
